
```{r loading packages and data}
# loading packages
library(tidyverse) # for general data analysis
library(here) # enables relative file paths
library(haven) # for reading in foreign (e.g. Stata) file formats
library(skimr) # provides extensive set of summary stats
library(janitor) # for making nice variable names (snake_case)
library(ggthemes) # for accessing more themes
library(styler) # makes sure code conforms to tidyverse style guidelines
library(countrycode) # for getting regions of countries

## cleaned stata data - we want to create something similar in r
stata_cleaned <- read_dta(here("stata", "UG_Cleaned_Dataset.dta"))
```

```{r skimming data}
skim(stata_cleaned)
```

# Survey Data
```{r UG Survey}
# read in and wrangle data ####
ug_survey <- read_csv(here("data", "survey", "Survey - GenAI_March 13, 2024_15.24.csv")) %>% # this one has more rows than one from Feb, so I assume it's the right one
  clean_names() %>% # put names in snake_case
  filter(distribution_channel == "anonymous") %>% # filter for actual ppt data
  type_convert() %>% # let tidyverse guess variable types - does pretty good job
  rename( # shorter variable names
    duration_s = duration_in_seconds,
    # Jordana's renaming of vars
    participinfo = q6,
    consent = q7,
    interviews = q8,
    entexp = q14,
    xposent = q16,
    prog = q17,
    cse1 = q21_1,
    cse2 = q22_1,
    cse3 = q23_1,
    pinno1 = q26_1,
    pinno2 = q27_1,
    pinno3 = q28_1,
    pl1 = q31_1,
    cl1 = q32_1,
    cl2 = q33_1,
    pl2 = q34_1,
    cl3 = q35_1,
    ml1 = q36_1,
    ml2 = q37_1,
    pl3 = q38_1,
    ml3 = q39_1,
    frequse = q40,
    useplan = q41,
    useprof = q42,
    useacad = q43,
    se1 = q46_1,
    se2 = q47_1,
    se3 = q48_1,
    gender = q50,
    ageoriginal = q51,
    # rename unique id vars
    id_1 = q55,
    id_2 = q56,
    id_3 = q57,
    id_4 = q58,
    id_5 = q59,
    # create variable for HS country
    hscountry = q52
  ) %>%
  mutate(
    gender = factor(gender),
    uk = if_else(hscountry == "United Kingdom of Great Britain and Northern Ireland", 1, 0), # create binary variable for UK
    across(c(id_1:id_5), ~ tolower(.)),
    .after = hscountry
  ) %>%
  mutate(
    userid = paste0(id_1, id_2, id_3, id_4, id_5),
    .before = 1
  ) %>% 
  filter(progress > 87) %>% # filter for completion rate > 87% (Jordana's cutoff)
  select(-c(interviews)) # drop variable for interviews

# q14 recoding- entrepreneurial experience ####
ug_survey <- ug_survey %>%
  mutate(
    # entrepreneurial exposure – narrower
    entxn = ifelse(entexp %in% c(
      "I have experience as an entrepreneur.",
      "I have experience as a business owner."
    ),
    "entrepreneurial experience – narrower", 0
    ),
    # entrepreneurial exposure – broader
    entxb = ifelse(entexp %in% c(
      "I have experience as an entrepreneur.",
      "I have experience as a business owner.",
      "I have experience as a self-employed person."
    ), "entrepreneurial experience –broader", 0),
    .after = entexp
  )

# q16 recoding - Exposure to entrepreneurship ####
ug_survey <- ug_survey %>%
  mutate(
    # entrepreneurial exposure – narrower
    xposen = ifelse(xposent %in% c(
      "At least one of my parents has experience as entrepreneur.",
      "At least one of my parents has experience as business owner."
    ),
    "entrepreneurial experience – narrower", 0
    ),
    # entrepreneurial exposure – broader
    xposeb = ifelse(xposent %in% c(
      "At least one of my parents has experience as entrepreneur.",
      "At least one of my parents has experience as business owner.",
      "At least one of my parents has experience as a self-employed person."
    ),
    "entrepreneurial experience – broader", 0
    ),
    .after = xposent
  )

# q17 recoding - Programme ####
ug_survey <- ug_survey %>%
  mutate(
    programme = case_when( # create variable for programme
      prog == "A programme at the Business School." ~ "Business programme at the business school",
      prog %in% c(
        "Law and Business / Psychology and Business / Economics and Management.",
        "Language and Business (for example, French and Business, German and Business).",
        "Mathematics and Business.",
        "I am an exchange student, but I study business in my home university."
      ) ~ "Another programme with a business component",
      .default = "A programme without a business component"
    ),
    .after = prog
  )

# q21-23 recoding - creative self-efficacy (CSE) ####
ug_survey <- ug_survey %>%
  mutate(
    across(c(cse1:cse3), ~ factor(.,
      levels = c(
        "Totally disagree",
        "Mostly disagree",
        "Slightly disagree",
        "Neutral",
        "Slightly agree",
        "Mostly agree",
        "Totally agree"
      ),
      labels = c(1, 2, 3, 4, 5, 6, 7)
    )),
    across(c(cse1:cse3), ~ as.numeric(as.character(.))),
    creativese = rowMeans(across(c(cse1:cse3)), na.rm = TRUE), # create variable for creative self-efficiency
    .after = cse3
  )

# q26-28 recoding - personal innovativeness ####
ug_survey <- ug_survey %>%
  mutate(
    across(c(pinno1:pinno3), ~ factor(.,
      levels = c(
        "Totally disagree",
        "Mostly disagree",
        "Slightly disagree",
        "Neutral",
        "Slightly agree",
        "Mostly agree",
        "Totally agree"
      ),
      labels = c(1, 2, 3, 4, 5, 6, 7)
    )),
    across(c(pinno1:pinno3), ~ as.numeric(as.character(.))),
    persinno = rowMeans(across(c(pinno1:pinno3)), na.rm = TRUE), # create variable for personal innovativeness)
    .after = pinno3
  )

# q31-39 - pragmatic, moral and cognitive legitimacy ####
ug_survey <- ug_survey %>%
  mutate(
    across(c(pl1:ml3), ~ factor(.,
      levels = c(
        "Totally disagree",
        "Mostly disagree",
        "Slightly disagree",
        "Neutral",
        "Slightly agree",
        "Mostly agree",
        "Totally agree"
      ),
      labels = c(1, 2, 3, 4, 5, 6, 7)
    )),
    across(c(pl1:ml3), ~ as.numeric(as.character(.))),
    pl = rowMeans(across(c(pl1,pl2,pl3)), na.rm = TRUE), # pragmatic legitimacy
    cl = rowMeans(across(c(cl1,cl2,cl3)), na.rm = TRUE), # cognitive legitimacy
    ml = rowMeans(across(c(ml1,ml2,ml3)), na.rm = TRUE), # moral legitimacy
    .after = ml3
  )


# q40 recoding - Frequency of GenAI use ####
ug_survey <- ug_survey %>%
  mutate(
    frequentuser = ifelse(frequse %in% c(
      "Once or more each day.",
      "Several times each week."
    ),
    "frequent generative AI user", 0
    ), # create variable for frequent generative AI user
    .after = frequse
  )

# q41-43 recoding - Frequency of GenAI use: Planning, Professional and Academic ####
ug_survey <- ug_survey %>%
  mutate(
    across(c(useplan:useacad), ~ factor(.,
      levels = c(
        "I use Generative AI quite often for this type of purpose.",
        "I have used Generative AI occasionally for this type of purpose.",
        "I have never used Generative AI for this type of purpose."
      ),
      labels = c(1, 2, 3)
    )),
    across(c(useplan:useacad), ~ as.numeric(as.character(.))),
    usecontext = rowMeans(across(c(useplan:useacad)), na.rm = TRUE), # create variable for Use In Context
    .after = useacad
  )

# q46-48 recoding - self efficacy: confidence, mastery and expectations ####
ug_survey <- ug_survey %>%
  mutate(
    selfefficacy = rowMeans(across(c(se1:se3)), na.rm = TRUE), # create variable for self efficacy
    .after = se3
  ) # Note: didn't need to code as factor first because was already numeric

# q51 recoding - age ####
skim(ug_survey$ageoriginal) # ranges from 18-44

ug_survey %>%
  count(ageoriginal) %>%
  arrange(desc(ageoriginal)) %>%
  # filter(n >= 5) %>%

  filter(n > 5) %>%
  summarise(sum(n) / n_distinct(ug_survey$response_id))

  # filter(ageoriginal>21) %>%
  # filter(n >= 5) %>%

# q52 recoding - hscountry ####
ug_survey %>%
  count(hscountry) %>%
  arrange(desc(n)) %>%
  # filter(n > 5) %>%
  filter(n <= 5) %>%
  summarise(sum(n) / n_distinct(ug_survey$response_id))

  # filter(ageoriginal>21) %>%
  # filter(n >= 5) %>%

ug_survey <- ug_survey %>%
  group_by(hscountry) %>% 
  mutate(
    hscountry = case_when(
      hscountry == "United States of America" ~ "United States",
      hscountry == "United Kingdom of Great Britain and Northern Ireland" ~ "United Kingdom",
      .default = hscountry
    ),
    country_n = n(),
    .after = hscountry
  ) %>% 
  ungroup() %>% 
  mutate(
    country_group = case_when(
      country_n <= 5 ~ countrycode(hscountry, origin = "country.name", destination = "region"),
      .default = hscountry),
    .after = country_n
  )

# create unique userid for merging ####
skim(ug_survey)
```
- 228 unique userids

- *Age:* There are 14 ages (*26 obs ~ 11% of data*) which have five or fewer observations, ranging from 18-44. The vast majority of respondents (*89.3%*) are between 21-24 inclusive, so perhaps we could add a category for < 21 (*2% of ppts*) and >24 (*8.7% of ppts*)? Alternatively, I often see surveys/reports that group people into the categories:
  - 18-24 (*91.3% of our ppts*)
  - 25-34 (*6.2% of our ppts*)
  - 35-44 (*2.5% of our ppts*)
  
- *HS Country:* There are 31 countries (*51 obs ~ 21% of data*) which have five or fewer observations. The vast majority of respondents (*~79%*) are from just four countries: China (*46%*), the UK (*27%*), India (*3%*) and the US (*3%*).


# Experiment Data
```{r UG Experiment}
ug_exp <- read_csv(here("data", "experiment", "Submission_February 14, 2024_15.45.csv")) %>% 
  clean_names() %>% # put names in snake_case
  filter(distribution_channel == "anonymous") %>% # filter for actual ppt data
  type_convert() %>% # let tidyverse guess variable types - does pretty good job
  rename(
    duration_s = duration_in_seconds,
     # rename unique id vars
    id_1 = q2,
    id_2 = q3,
    id_3 = q4,
    id_4 = q5,
    id_5 = q6,
  ) %>%
  mutate(
    userid = paste0(id_1, id_2, id_3, id_4, id_5),
    .before = 1
  ) 

# skim
skim(ug_exp)
```
- 198 unique userids

```{r MSc Experiment}
# read in and wrangle data
pg_exp <- read_csv(here("data", "experiment", "MSc Experiment March 13, 2024_15.25.csv"), col_names = T) %>%
  clean_names() %>% # put names in snake_case
  filter(distribution_channel == "anonymous") %>% # filter for actual ppt data
  type_convert() %>% # let tidyverse guess variable types - does pretty good job
  rename(
    duration_s = duration_in_seconds,
    id_1 = q3,
    id_2 = q4_12,
    id_3 = q5,
    id_4 = q6_14,
    id_5 = q7,
  ) %>%
  mutate(
    userid = paste0(id_1, id_2, id_3, id_4, id_5),
    .before = 1
  )

# skim
skim(pg_exp)
```
- 27 unique userids (looks good)